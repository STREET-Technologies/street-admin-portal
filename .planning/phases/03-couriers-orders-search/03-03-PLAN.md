# Plan 03-03: Global Search

## Context

The admin portal needs a unified search that lets support staff find any entity (user, retailer, order) quickly. The design uses a cmdk-based command palette triggered from the header search bar — similar to Stripe's Cmd+K or GitHub's search.

**Backend search capabilities:**
- `GET /admin/users?search=X` — searches users by name, email, or phone
- `GET /admin/vendors?name=X` — searches vendors by store name
- No order search endpoint exists — order lookup by orderId requires knowing the vendor or user first

**Approach:** Fire parallel requests to user and vendor search endpoints on each keystroke (debounced). Group results by entity type in the dropdown. For orders, allow searching by order ID format (ST-XXXXX) — this would need to match against known order data or be handled as a "navigate to order" shortcut if we have the order ID.

The cmdk component (`src/components/ui/command.tsx`) is already installed from shadcn.

## Dependencies

- Plan 03-01: Order types (for search result display)
- Phase 02-02: User types, user API (for user search)
- Phase 02-03: Retailer types, retailer API (for vendor search)
- Phase 01-03: API client

## Requirements Addressed

- SRCH-01: Search across all entity types from single input
- SRCH-02: Results grouped by entity type with type-ahead suggestions
- SRCH-03: Search supports name, email, phone, and order ID

## Tasks

### Task 1: Create search API function

**Create `src/features/search/api/search-api.ts`:**

```typescript
export interface SearchResults {
  users: SearchResultItem[];
  retailers: SearchResultItem[];
  orders: SearchResultItem[];
}

export interface SearchResultItem {
  id: string;
  type: "user" | "retailer" | "order";
  title: string;       // Primary display text
  subtitle: string;    // Secondary text (email, store name, etc.)
  avatarUrl?: string;
  status?: string;
  href: string;        // Route to navigate to
}

// Aggregates results from multiple admin endpoints in parallel
export async function globalSearch(query: string): Promise<SearchResults> {
  // Fire user + vendor searches in parallel
  const [usersResponse, vendorsResponse] = await Promise.allSettled([
    getUsers({ search: query, page: 1, limit: 5 }),
    getRetailers({ name: query, page: 1, limit: 5 }),
  ]);

  // Map results to SearchResultItem format
  // For orders: check if query matches ST-XXXXX pattern
  // If so, construct a direct link to /orders/{orderId}
}
```

### Task 2: Create GlobalSearch component

**Create `src/features/search/components/GlobalSearch.tsx`:**

Uses shadcn CommandDialog (cmdk). Behavior:
- Input in the header bar shows a search icon + "Search..." placeholder
- Clicking it (or pressing Cmd+K / Ctrl+K) opens the command dialog
- Typing debounces (300ms) and fires `globalSearch()`
- Results are grouped by type: Users, Retailers, Orders
- Each result shows: avatar/icon + title + subtitle + status badge
- Selecting a result navigates to the entity detail page and closes the dialog
- Empty state: "No results found" when query has no matches
- Loading state: spinner or skeleton while searching

```typescript
interface GlobalSearchProps {
  // No props needed — self-contained
}

export function GlobalSearch() {
  const [open, setOpen] = useState(false);
  const [query, setQuery] = useState("");
  const debouncedQuery = useDebounce(query, 300);

  // Keyboard shortcut: Cmd+K / Ctrl+K
  useEffect(() => {
    const handler = (e: KeyboardEvent) => {
      if ((e.metaKey || e.ctrlKey) && e.key === "k") {
        e.preventDefault();
        setOpen(true);
      }
    };
    document.addEventListener("keydown", handler);
    return () => document.removeEventListener("keydown", handler);
  }, []);

  // Search query
  const { data, isLoading } = useGlobalSearchQuery(debouncedQuery);

  return (
    <CommandDialog open={open} onOpenChange={setOpen}>
      <CommandInput value={query} onValueChange={setQuery} placeholder="Search users, retailers, orders..." />
      <CommandList>
        {isLoading && <CommandLoading>Searching...</CommandLoading>}
        <CommandEmpty>No results found.</CommandEmpty>

        {data?.users.length > 0 && (
          <CommandGroup heading="Users">
            {data.users.map(item => <SearchResultRow key={item.id} item={item} />)}
          </CommandGroup>
        )}
        {data?.retailers.length > 0 && (
          <CommandGroup heading="Retailers">
            {data.retailers.map(item => <SearchResultRow key={item.id} item={item} />)}
          </CommandGroup>
        )}
        {data?.orders.length > 0 && (
          <CommandGroup heading="Orders">
            {data.orders.map(item => <SearchResultRow key={item.id} item={item} />)}
          </CommandGroup>
        )}
      </CommandList>
    </CommandDialog>
  );
}
```

### Task 3: Create search query hook

**Create `src/features/search/api/search-queries.ts`:**

```typescript
export const searchKeys = {
  all: ["search"] as const,
  query: (q: string) => [...searchKeys.all, q] as const,
};

export function useGlobalSearchQuery(query: string) {
  return useQuery({
    queryKey: searchKeys.query(query),
    queryFn: () => globalSearch(query),
    enabled: query.length >= 2,
    staleTime: 30_000,  // Cache results for 30s
  });
}
```

### Task 4: Integrate GlobalSearch into header

**Update `src/app/layout/AppLayout.tsx`:**

Add the GlobalSearch trigger button in the header bar between the breadcrumbs and theme toggle. The button shows a search icon + "Search..." + keyboard shortcut hint (Cmd+K).

```tsx
<header className="flex h-14 items-center gap-2 border-b px-6">
  <SidebarTrigger />
  <Separator orientation="vertical" className="h-4" />
  <Breadcrumbs />
  <div className="ml-auto flex items-center gap-2">
    <GlobalSearch />
    <ThemeToggle />
  </div>
</header>
```

The GlobalSearch component renders both the trigger button and the CommandDialog.

## Commit

Single commit: `feat(03-03): global search with cmdk command palette`

## Success Criteria

- [ ] Clicking search button or pressing Cmd+K opens search dialog
- [ ] Typing searches users and retailers in parallel with debounce
- [ ] Results are grouped by entity type (Users, Retailers, Orders)
- [ ] Selecting a result navigates to the correct detail page
- [ ] Order ID format (ST-XXXXX) is recognized and creates a direct link
- [ ] Empty and loading states display correctly
- [ ] `npm run build` passes with no TypeScript errors

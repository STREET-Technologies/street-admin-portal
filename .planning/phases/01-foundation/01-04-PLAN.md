---
phase: 01-foundation
plan: 04
type: execute
wave: 3
depends_on: ["01-02", "01-03"]
files_modified:
  - src/app/App.tsx
  - src/app/providers.tsx
  - src/app/layout/AppLayout.tsx
  - src/app/layout/AppSidebar.tsx
  - src/app/layout/Breadcrumbs.tsx
  - src/app/layout/ProtectedRoute.tsx
  - src/app/layout/ThemeToggle.tsx
  - src/app/routes/__root.tsx
  - src/app/routes/login.tsx
  - src/app/routes/_authenticated.tsx
  - src/app/routes/_authenticated/index.tsx
  - src/app/routes/_authenticated/users/index.tsx
  - src/app/routes/_authenticated/retailers/index.tsx
  - src/app/routes/_authenticated/couriers/index.tsx
  - src/app/routes/_authenticated/orders/index.tsx
  - src/app/routes/_authenticated/referrals/index.tsx
  - src/app/routes/_authenticated/settings/index.tsx
  - src/constants/navigation.ts
  - src/main.tsx
autonomous: false
must_haves:
  truths:
    - "Admin can navigate between sections via persistent left sidebar"
    - "Sidebar highlights the active section based on current URL"
    - "Breadcrumbs show current location on all pages below top level"
    - "All pages have unique URLs that survive browser refresh"
    - "Back/forward browser navigation works correctly"
    - "Unauthenticated users are redirected to login page"
    - "Dark mode toggle switches between light and dark themes"
    - "Dark mode respects OS preference on first visit"
    - "Each section page shows a placeholder with loading/empty state"
  artifacts:
    - path: "src/app/layout/AppLayout.tsx"
      provides: "Main layout with sidebar + content area"
      exports: ["AppLayout"]
      min_lines: 20
    - path: "src/app/layout/AppSidebar.tsx"
      provides: "Sidebar navigation with grouped items"
      exports: ["AppSidebar"]
      min_lines: 30
    - path: "src/app/layout/Breadcrumbs.tsx"
      provides: "Dynamic breadcrumb trail from route"
      exports: ["Breadcrumbs"]
    - path: "src/app/layout/ProtectedRoute.tsx"
      provides: "Auth guard that redirects to /login"
      exports: ["ProtectedRoute"]
    - path: "src/app/layout/ThemeToggle.tsx"
      provides: "Light/dark/system theme switcher"
      exports: ["ThemeToggle"]
    - path: "src/app/App.tsx"
      provides: "Root app component with all providers"
      exports: ["default"]
    - path: "src/main.tsx"
      provides: "Entry point rendering App with router"
      contains: "createRoot"
    - path: "src/constants/navigation.ts"
      provides: "Sidebar navigation configuration"
      exports: ["navGroups"]
  key_links:
    - from: "src/app/layout/ProtectedRoute.tsx"
      to: "src/features/auth/hooks/useAuth.ts"
      via: "checks isAuthenticated before rendering children"
      pattern: "useAuth"
    - from: "src/app/layout/AppSidebar.tsx"
      to: "src/constants/navigation.ts"
      via: "renders navigation items from config"
      pattern: "navGroups"
    - from: "src/app/routes/__root.tsx"
      to: "src/app/App.tsx"
      via: "root route renders providers and outlet"
    - from: "src/app/routes/_authenticated.tsx"
      to: "src/app/layout/ProtectedRoute.tsx"
      via: "authenticated route group wraps with auth guard"
      pattern: "ProtectedRoute"
---

<objective>
Build the complete app shell with sidebar navigation, routing, breadcrumbs, auth protection, and dark mode.

Purpose: NAV-01 (sidebar), NAV-02 (breadcrumbs), NAV-03 (URL routing), AUTH-03 (auth redirect), INFR-06 (dark mode). This is the frame everything else fits into.
Output: Working app with sidebar navigation, protected routes, placeholder pages, and dark mode toggle.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/ARCHITECTURE.md (AppLayout, AppSidebar, ProtectedRoute, routing patterns)
@.planning/research/STACK.md (TanStack Router setup, file-based routing)

Prior plan outputs (will exist at execution time):
@.planning/phases/01-foundation/01-02-SUMMARY.md (shared components available)
@.planning/phases/01-foundation/01-03-SUMMARY.md (auth system available)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create routing structure with TanStack Router</name>
  <files>src/app/routes/__root.tsx, src/app/routes/login.tsx, src/app/routes/_authenticated.tsx, src/app/routes/_authenticated/index.tsx, src/app/routes/_authenticated/users/index.tsx, src/app/routes/_authenticated/retailers/index.tsx, src/app/routes/_authenticated/couriers/index.tsx, src/app/routes/_authenticated/orders/index.tsx, src/app/routes/_authenticated/referrals/index.tsx, src/app/routes/_authenticated/settings/index.tsx, src/main.tsx, src/app/App.tsx, src/app/providers.tsx</files>
  <action>
    Set up TanStack Router with file-based routing. The TanStack Router Vite plugin (configured in Plan 01) auto-generates src/routeTree.gen.ts from the routes directory.

    **src/app/providers.tsx:**
    Compose all providers in one file:
    ```typescript
    import { QueryClientProvider } from "@tanstack/react-query";
    import { ReactQueryDevtools } from "@tanstack/react-query-devtools";
    import { ThemeProvider } from "next-themes";
    import { Toaster } from "@/components/ui/sonner";
    import { TooltipProvider } from "@/components/ui/tooltip";
    import { AuthProvider } from "@/features/auth/context/AuthProvider";
    import { queryClient } from "@/lib/query-client";

    export function Providers({ children }: { children: React.ReactNode }) {
      return (
        <ThemeProvider attribute="class" defaultTheme="system" enableSystem>
          <QueryClientProvider client={queryClient}>
            <AuthProvider>
              <TooltipProvider>
                {children}
                <Toaster richColors position="bottom-right" />
                <ReactQueryDevtools initialIsOpen={false} />
              </TooltipProvider>
            </AuthProvider>
          </QueryClientProvider>
        </ThemeProvider>
      );
    }
    ```

    **src/app/routes/__root.tsx:**
    The root route wraps everything in Providers:
    ```typescript
    import { createRootRoute, Outlet } from "@tanstack/react-router";
    import { Providers } from "@/app/providers";

    export const Route = createRootRoute({
      component: () => (
        <Providers>
          <Outlet />
        </Providers>
      ),
    });
    ```

    **src/app/routes/login.tsx:**
    Public route for login page:
    ```typescript
    import { createFileRoute } from "@tanstack/react-router";
    import { LoginPage } from "@/features/auth/components/LoginPage";

    export const Route = createFileRoute("/login")({
      component: LoginPage,
    });
    ```

    **src/app/routes/_authenticated.tsx:**
    Layout route that wraps all authenticated pages with ProtectedRoute + AppLayout:
    ```typescript
    import { createFileRoute, Outlet } from "@tanstack/react-router";
    import { ProtectedRoute } from "@/app/layout/ProtectedRoute";
    import { AppLayout } from "@/app/layout/AppLayout";

    export const Route = createFileRoute("/_authenticated")({
      component: () => (
        <ProtectedRoute>
          <AppLayout>
            <Outlet />
          </AppLayout>
        </ProtectedRoute>
      ),
    });
    ```

    **Placeholder pages for each section:**
    Create route files at: _authenticated/index.tsx (redirects to /users), _authenticated/users/index.tsx, _authenticated/retailers/index.tsx, _authenticated/couriers/index.tsx, _authenticated/orders/index.tsx, _authenticated/referrals/index.tsx, _authenticated/settings/index.tsx

    Each placeholder page:
    ```typescript
    import { createFileRoute } from "@tanstack/react-router";
    import { PageHeader } from "@/components/shared/PageHeader";
    import { EmptyState } from "@/components/shared/EmptyState";
    import { Users } from "lucide-react"; // appropriate icon per page

    export const Route = createFileRoute("/_authenticated/users/")({
      component: UsersPage,
    });

    function UsersPage() {
      return (
        <div className="space-y-6">
          <PageHeader title="Users" description="Manage user accounts" />
          <EmptyState
            icon={Users}
            title="Users coming soon"
            description="User list and detail views will be built in Phase 2."
          />
        </div>
      );
    }
    ```

    The root authenticated index should redirect to /users:
    ```typescript
    import { createFileRoute, redirect } from "@tanstack/react-router";

    export const Route = createFileRoute("/_authenticated/")({
      beforeLoad: () => {
        throw redirect({ to: "/users" });
      },
    });
    ```

    **src/app/App.tsx:**
    Create router and render it:
    ```typescript
    import { createRouter, RouterProvider } from "@tanstack/react-router";
    import { routeTree } from "@/routeTree.gen";

    const router = createRouter({ routeTree });

    // Type-safe router declaration
    declare module "@tanstack/react-router" {
      interface Register {
        router: typeof router;
      }
    }

    export default function App() {
      return <RouterProvider router={router} />;
    }
    ```

    **src/main.tsx:**
    Update to render App:
    ```typescript
    import React from "react";
    import ReactDOM from "react-dom/client";
    import App from "@/app/App";
    import "./index.css";

    ReactDOM.createRoot(document.getElementById("root")!).render(
      <React.StrictMode>
        <App />
      </React.StrictMode>
    );
    ```

    Run `npm run dev` to trigger TanStack Router plugin to generate routeTree.gen.ts.
  </action>
  <verify>
    `npm run dev` starts without errors.
    routeTree.gen.ts is auto-generated.
    Navigate to /login shows login page.
    Navigate to / redirects to /users (or login if not authenticated).
    `npm run build` succeeds.
  </verify>
  <done>TanStack Router file-based routing set up with root, login, and authenticated layout routes. All section pages have placeholder content.</done>
</task>

<task type="auto">
  <name>Task 2: Create app shell (sidebar, breadcrumbs, theme toggle, protected route)</name>
  <files>src/app/layout/AppLayout.tsx, src/app/layout/AppSidebar.tsx, src/app/layout/Breadcrumbs.tsx, src/app/layout/ProtectedRoute.tsx, src/app/layout/ThemeToggle.tsx, src/constants/navigation.ts</files>
  <action>
    **src/constants/navigation.ts:**
    Define sidebar navigation configuration:
    ```typescript
    import { Users, Store, Truck, ShoppingCart, Tag, Settings } from "lucide-react";

    export const navGroups = [
      {
        label: "Customers",
        items: [
          { title: "Users", icon: Users, href: "/users" },
          { title: "Retailers", icon: Store, href: "/retailers" },
          { title: "Couriers", icon: Truck, href: "/couriers" },
        ],
      },
      {
        label: "Operations",
        items: [
          { title: "Orders", icon: ShoppingCart, href: "/orders" },
          { title: "Referral Codes", icon: Tag, href: "/referrals" },
        ],
      },
      {
        label: "System",
        items: [
          { title: "Settings", icon: Settings, href: "/settings" },
        ],
      },
    ];
    ```

    **src/app/layout/ProtectedRoute.tsx:**
    Auth guard wrapper:
    - Uses useAuth() hook to check isAuthenticated and isLoading
    - If loading: show centered spinner (or LoadingState variant="page")
    - If not authenticated: redirect to /login using TanStack Router's Navigate component
    - Preserve the attempted URL for post-login redirect (use useLocation from @tanstack/react-router, pass state)
    - If authenticated: render children

    **src/app/layout/AppLayout.tsx:**
    Main layout using shadcn/ui Sidebar components:
    - SidebarProvider wraps everything
    - AppSidebar on the left
    - SidebarInset contains: header bar (SidebarTrigger + separator + Breadcrumbs + ThemeToggle + user menu) and main content area
    - Header: flex h-14 items-center gap-2 border-b px-6
    - Main: flex-1 overflow-auto p-6
    - children prop for route content (not Outlet — the parent route renders Outlet)

    **src/app/layout/AppSidebar.tsx:**
    Stripe-style sidebar:
    - SidebarHeader: STREET logo (use Hanson font class "street-logo", smaller size text-xl)
    - SidebarContent: render navGroups with SidebarGroup, SidebarGroupLabel, SidebarMenu, SidebarMenuItem, SidebarMenuButton
    - Active state: use `useLocation` from TanStack Router, compare pathname.startsWith(item.href)
    - Use Link from @tanstack/react-router for navigation (not react-router-dom)
    - SidebarFooter: user display (email from useAuth) + logout button
    - Logout button calls useAuth().logout() then navigates to /login

    **src/app/layout/Breadcrumbs.tsx:**
    Dynamic breadcrumb from current route:
    - Use useLocation() from TanStack Router to get pathname
    - Split pathname into segments
    - Map segments to labels (capitalize, map "users" → "Users", etc.)
    - Use shadcn/ui Breadcrumb, BreadcrumbList, BreadcrumbItem, BreadcrumbLink, BreadcrumbSeparator
    - First item always "Home" linking to /
    - Last item is current page (not a link, just text)
    - Don't show breadcrumbs on the root/home page (only on pages below top level)

    **src/app/layout/ThemeToggle.tsx:**
    Dark mode toggle:
    - Use next-themes useTheme() hook
    - shadcn/ui Button with ghost variant + Dropdown menu
    - Three options: Light (Sun icon), Dark (Moon icon), System (Monitor icon)
    - Show current theme's icon on the button
    - On click: cycle light → dark → system, or use dropdown for explicit selection
    - Small size, sits in the header bar
  </action>
  <verify>
    `npm run build` succeeds.
    `npx tsc --noEmit` passes.
    All layout components exist in src/app/layout/.
    navigation.ts exports navGroups with 3 groups and 6 total items.
  </verify>
  <done>Complete app shell with sidebar navigation, breadcrumbs, theme toggle, and auth protection. All section pages accessible via sidebar.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete app shell: sidebar navigation, breadcrumbs, routing, auth protection, dark mode toggle, placeholder pages for all sections</what-built>
  <how-to-verify>
    1. Run: `npm run dev`
    2. Visit: http://localhost:8081
    3. Should redirect to /login page (if not authenticated)
    4. Login page shows STREET logo, Google Sign-In button
    5. If VITE_DEV_BYPASS_AUTH=true is set, click Dev Bypass to log in
    6. After login: sidebar visible with 3 groups (Customers, Operations, System)
    7. Click each sidebar item: URL changes, page shows placeholder, sidebar highlights active item
    8. Breadcrumbs update as you navigate (e.g., Home > Users)
    9. Dark mode: click theme toggle in header, switch between light/dark/system
    10. Browser back/forward buttons work correctly
    11. Refresh page: stays on current route (doesn't lose state)
    12. URL is bookmarkable (copy URL, paste in new tab)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run dev` starts without errors
- [ ] `npm run build` succeeds
- [ ] Sidebar navigation works with 6 sections
- [ ] Breadcrumbs show on sub-pages
- [ ] URLs are unique and refresh-safe
- [ ] Auth redirect works (unauthenticated → /login)
- [ ] Dark mode toggle works with system preference
- [ ] Human verification passed
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human approved the visual layout and navigation
- Phase 1 complete: working app shell ready for feature development
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-04-SUMMARY.md`
</output>

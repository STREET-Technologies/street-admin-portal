---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/lib/api-client.ts
  - src/lib/query-client.ts
  - src/features/auth/context/AuthProvider.tsx
  - src/features/auth/hooks/useAuth.ts
  - src/features/auth/api/auth-api.ts
  - src/features/auth/components/LoginPage.tsx
  - src/features/auth/types.ts
autonomous: true
must_haves:
  truths:
    - "API client attaches Bearer token to all requests"
    - "API client redirects to /login on 401 response"
    - "API client reads base URL from VITE_API_URL env var"
    - "Auth provider checks localStorage token on mount and validates via /auth/me"
    - "Login page redirects to Google OAuth endpoint"
    - "Login page handles OAuth callback (tokens in URL hash)"
    - "Logout calls /auth/logout BEFORE clearing token"
    - "Auth state persists across browser refresh"
  artifacts:
    - path: "src/lib/api-client.ts"
      provides: "Centralized API client with auth, error handling, and response unwrapping"
      exports: ["api", "ApiError"]
      min_lines: 40
    - path: "src/lib/query-client.ts"
      provides: "TanStack Query client configuration"
      exports: ["queryClient"]
    - path: "src/features/auth/context/AuthProvider.tsx"
      provides: "Auth state management with token validation"
      exports: ["AuthProvider"]
    - path: "src/features/auth/hooks/useAuth.ts"
      provides: "Hook to access auth state"
      exports: ["useAuth"]
    - path: "src/features/auth/components/LoginPage.tsx"
      provides: "Google OAuth login page"
      contains: "handleGoogleLogin"
    - path: "src/features/auth/api/auth-api.ts"
      provides: "Auth-related API calls"
      exports: ["authApi"]
  key_links:
    - from: "src/lib/api-client.ts"
      to: "localStorage access_token"
      via: "reads token for Authorization header"
      pattern: "localStorage.getItem"
    - from: "src/lib/api-client.ts"
      to: "VITE_API_URL"
      via: "import.meta.env for base URL"
      pattern: "import\\.meta\\.env\\.VITE_API_URL"
    - from: "src/features/auth/context/AuthProvider.tsx"
      to: "src/features/auth/api/auth-api.ts"
      via: "validates token on mount"
      pattern: "authApi"
    - from: "src/features/auth/components/LoginPage.tsx"
      to: "Google OAuth"
      via: "redirects to backend /auth/admin/google"
      pattern: "/auth/admin/google"
---

<objective>
Build the centralized API client and complete auth system.

Purpose: AUTH-01 through AUTH-04 (Google OAuth login, logout fix, auth redirect, session persistence) plus INFR-01 (centralized API client), INFR-03 (env var config), INFR-04 (toast notifications on mutations).
Output: Working auth flow with centralized API client that all features will use.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/ARCHITECTURE.md (API client pattern, auth provider pattern, data flow diagrams)

Source files from old codebase (reference for behavior, don't copy structure):
@src/services/api.ts (current API service — centralize and clean up)
@src/pages/Index.tsx (current auth check flow — fix the logout bug)
@src/components/Login.tsx (current login page — preserve OAuth callback handling)

Key backend endpoints:
- GET /v1/auth/me — validate token, returns { data: { email, ... } }
- POST /v1/auth/logout — invalidate session (needs token in header!)
- GET /v1/auth/admin/google — initiates Google OAuth flow
- OAuth callback returns tokens in URL hash: #access_token=...&refresh_token=...
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create centralized API client and query client</name>
  <files>src/lib/api-client.ts, src/lib/query-client.ts</files>
  <action>
    **src/lib/api-client.ts:**

    Create a typed API client using ky (HTTP library). Key requirements:

    1. Base URL from `import.meta.env.VITE_API_URL` with fallback to 'http://localhost:8080/v1'
    2. ky instance configured with:
       - prefixUrl: base URL
       - hooks.beforeRequest: inject Authorization Bearer token from localStorage('access_token')
       - hooks.afterResponse: on 401, clear localStorage tokens and redirect to /login
       - timeout: 30000ms
       - retry: { limit: 2, methods: ['get'] } (only retry GETs)
    3. Custom ApiError class with status, statusText, and data properties
    4. Typed convenience methods:
       - api.get<T>(endpoint) — returns parsed JSON
       - api.post<T>(endpoint, body) — returns parsed JSON
       - api.patch<T>(endpoint, body) — returns parsed JSON
       - api.delete<T>(endpoint) — returns parsed JSON
    5. Response envelope unwrapping: if response has { data: T }, unwrap and return T
    6. Error handling: catch ky HTTPError, extract response body, throw ApiError with status + message

    Do NOT use raw fetch — use ky for its hook system and cleaner API.

    **src/lib/query-client.ts:**

    Create TanStack Query client with sensible defaults:
    ```typescript
    import { QueryClient } from "@tanstack/react-query";

    export const queryClient = new QueryClient({
      defaultOptions: {
        queries: {
          staleTime: 1000 * 60 * 2, // 2 minutes
          retry: 1,
          refetchOnWindowFocus: false,
        },
        mutations: {
          retry: 0,
        },
      },
    });
    ```
  </action>
  <verify>
    `npx tsc --noEmit` passes for both files.
    api-client.ts exports `api` object and `ApiError` class.
    query-client.ts exports `queryClient`.
  </verify>
  <done>Centralized API client with ky, auth header injection, 401 redirect, and typed methods. Query client configured.</done>
</task>

<task type="auto">
  <name>Task 2: Create AuthProvider, useAuth hook, and auth API</name>
  <files>src/features/auth/context/AuthProvider.tsx, src/features/auth/hooks/useAuth.ts, src/features/auth/api/auth-api.ts, src/features/auth/types.ts</files>
  <action>
    **src/features/auth/types.ts:**
    ```typescript
    export interface AuthUser {
      email: string;
      name: string;
    }

    export interface AuthState {
      user: AuthUser | null;
      isAuthenticated: boolean;
      isLoading: boolean;
    }
    ```

    **src/features/auth/api/auth-api.ts:**
    Use the centralized api client from lib/api-client.ts:
    - `getCurrentUser()` — GET /auth/me, returns user data
    - `logout()` — POST /auth/logout (CRITICAL: must use token BEFORE clearing it)
    - `getGoogleLoginUrl()` — returns the full URL for Google OAuth redirect

    For logout, use ky directly with the token still in localStorage. The api client's beforeRequest hook will attach it. After the API call completes (success or failure), THEN clear localStorage.

    **src/features/auth/context/AuthProvider.tsx:**
    React Context provider that:
    1. On mount: checks localStorage for access_token
    2. If token exists: calls authApi.getCurrentUser() to validate
    3. If valid: sets user + isAuthenticated = true
    4. If invalid/expired: clears tokens, sets isAuthenticated = false
    5. Handles OAuth callback: checks URL hash for tokens on mount (same as current Login.tsx)
    6. Exposes login(token: string) and logout() functions
    7. logout() flow: call authApi.logout() FIRST → then clear localStorage → then set state. This fixes the existing bug where token is cleared before the API call.

    Handle the OAuth callback flow:
    - On mount, check window.location.hash for #access_token=...&refresh_token=...
    - If found: store tokens, clear hash from URL, validate via /auth/me
    - If hash contains error: show toast.error with the error message

    **src/features/auth/hooks/useAuth.ts:**
    Simple hook that consumes AuthContext:
    ```typescript
    export function useAuth() {
      const context = useContext(AuthContext);
      if (!context) throw new Error("useAuth must be used within AuthProvider");
      return context;
    }
    ```
  </action>
  <verify>
    `npx tsc --noEmit` passes for all auth files.
    AuthProvider exports and can be imported.
    useAuth hook is typed and throws on missing context.
  </verify>
  <done>Auth system with proper logout fix, OAuth callback handling, and token validation on mount. Centralized via React Context.</done>
</task>

<task type="auto">
  <name>Task 3: Create Login page</name>
  <files>src/features/auth/components/LoginPage.tsx</files>
  <action>
    Create the login page. Port the visual design from the existing Login.tsx but use the new auth system.

    Requirements:
    1. STREET logo header with brand styling (Hanson font for "STREET", lime-green gradient bar)
    2. Card with "Welcome Back" title and "Sign in with your STREET account" subtitle
    3. Google Sign-In button with Google SVG icon (copy from existing Login.tsx)
    4. Dev bypass button (shown only when VITE_DEV_BYPASS_AUTH=true)
    5. Footer note: "Admin access restricted to authorized accounts only"

    Use the useAuth() hook for login actions. The OAuth callback handling is in AuthProvider — this page just needs the initial redirect button.

    handleGoogleLogin: redirect to authApi.getGoogleLoginUrl() — which is `${VITE_API_URL}/auth/admin/google`

    handleDevBypass: call login with dev bypass token, show toast warning.

    Styling: same visual style as current Login.tsx but use shadcn/ui Card, CardHeader, CardContent, Button consistently. Keep the bg-gradient, backdrop-blur, shadow-2xl styling.

    This is a named export component, not a default export. Export as `LoginPage`.
  </action>
  <verify>
    `npx tsc --noEmit` passes.
    LoginPage component file exists and exports LoginPage.
    Component uses useAuth() hook — not raw localStorage.
    Component uses shadcn/ui Button and Card.
  </verify>
  <done>Login page with Google OAuth button, dev bypass, using new auth system. Matches existing visual design.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] `npx tsc --noEmit` passes (strict mode)
- [ ] API client uses ky with auth hooks
- [ ] API client reads VITE_API_URL from env
- [ ] AuthProvider handles OAuth callback (hash tokens)
- [ ] Logout calls API BEFORE clearing localStorage (bug fix verified in code)
- [ ] LoginPage redirects to /auth/admin/google
- [ ] No `any` types in any file
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Auth system complete and ready for integration with app shell
- Logout bug fixed (token cleared after API call, not before)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>

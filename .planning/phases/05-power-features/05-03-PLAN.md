---
phase: 05-power-features
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/shared/ActivityTimeline.tsx
  - src/features/users/components/UserDetailPage.tsx
  - src/features/users/components/UserActivityTab.tsx
  - src/features/retailers/components/RetailerDetailPage.tsx
  - src/features/retailers/components/RetailerActivityTab.tsx
autonomous: true

must_haves:
  truths:
    - "User detail page has an Activity tab showing a chronological timeline"
    - "Retailer detail page has an Activity tab showing a chronological timeline"
    - "Timeline shows notes as events with priority and author"
    - "Timeline shows account creation and last update as events"
    - "Events are sorted newest-first with relative timestamps"
  artifacts:
    - path: "src/components/shared/ActivityTimeline.tsx"
      provides: "Reusable timeline component"
      min_lines: 30
    - path: "src/features/users/components/UserActivityTab.tsx"
      provides: "User activity tab composing timeline"
    - path: "src/features/retailers/components/RetailerActivityTab.tsx"
      provides: "Retailer activity tab composing timeline"
  key_links:
    - from: "UserActivityTab"
      to: "useNotesQuery"
      via: "notes loaded and transformed to timeline events"
      pattern: "useNotesQuery"
    - from: "ActivityTimeline"
      to: "TimelineEvent[]"
      via: "generic event array prop"
      pattern: "TimelineEvent"
---

<objective>
Add a chronological activity timeline to entity detail pages (DETL-10).

Purpose: Gives admins a quick view of what happened with an entity — when it was created, what notes were added, when it was last updated. This provides at-a-glance context when handling support inquiries without clicking through multiple tabs.

Output: ActivityTimeline shared component, UserActivityTab, RetailerActivityTab added to their respective detail pages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/features/users/components/UserDetailPage.tsx
@src/features/retailers/components/RetailerDetailPage.tsx
@src/features/notes/types.ts
@src/features/notes/api/notes-queries.ts
@src/features/users/types.ts
@src/features/retailers/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ActivityTimeline component and TimelineEvent type</name>
  <files>src/components/shared/ActivityTimeline.tsx</files>
  <action>
    Create a generic, reusable ActivityTimeline component.

    **TimelineEvent type** (export from the same file):
    ```
    type: "note" | "created" | "updated" | "status_change"
    title: string (e.g., "Note added", "Account created")
    description?: string (e.g., note content, status detail)
    timestamp: string (ISO date)
    icon?: LucideIcon (optional, auto-assigned by type)
    metadata?: Record<string, string> (e.g., { author: "Gunnar", priority: "high" })
    ```

    **ActivityTimeline component props**:
    ```
    events: TimelineEvent[]
    isLoading?: boolean
    emptyMessage?: string
    ```

    **Layout** — Stripe-style vertical timeline:
    - Left: vertical line connecting dots
    - Each event: colored dot on the line + icon + title + timestamp + description
    - Dot colors: note = blue, created = green, updated = gray, status_change = amber
    - Timestamps as relative ("2 hours ago", "3 days ago") using `Intl.RelativeTimeFormat` or a simple helper
    - Notes show priority badge and author in metadata area
    - Sort events newest-first (component receives pre-sorted array)
    - Loading state: skeleton timeline (3-4 placeholder items)
    - Empty state: "No activity recorded" with History icon

    **Styling**: Use Tailwind for the timeline line (border-l-2), dots (rounded-full), and spacing. Keep it minimal and Stripe-like.
  </action>
  <verify>npm run build succeeds; ActivityTimeline component exported</verify>
  <done>ActivityTimeline component renders timeline events with proper layout, icons, relative timestamps, and handles loading/empty states</done>
</task>

<task type="auto">
  <name>Task 2: Create UserActivityTab and RetailerActivityTab, add to detail pages</name>
  <files>src/features/users/components/UserActivityTab.tsx, src/features/users/components/UserDetailPage.tsx, src/features/retailers/components/RetailerActivityTab.tsx, src/features/retailers/components/RetailerDetailPage.tsx</files>
  <action>
    **UserActivityTab** (`src/features/users/components/UserActivityTab.tsx`):
    Props: `{ userId: string; user: UserViewModel }`

    1. Fetch notes using `useNotesQuery("user", userId)` from notes-queries.ts
    2. Build TimelineEvent array from available data:
       - Map each note to a "note" event (title: "Note added", description: note content truncated to 200 chars, metadata: { author, priority })
       - Add "created" event from `user.createdAt` (title: "Account created")
       - Add "updated" event from `user.updatedAt` if different from createdAt (title: "Account updated")
    3. Sort all events by timestamp descending (newest first)
    4. Pass to ActivityTimeline with `isLoading` from notes query

    **RetailerActivityTab** (`src/features/retailers/components/RetailerActivityTab.tsx`):
    Props: `{ retailerId: string; retailer: RetailerViewModel }`

    Same pattern as UserActivityTab but:
    - Uses `useNotesQuery("vendor", retailerId)` (note: backend entityType is "vendor" not "retailer")
    - Created/Updated events from retailer.createdAt/updatedAt

    **Wire into detail pages**:

    **UserDetailPage**: Add "Activity" as a new tab after "Notes" tab. Import and render `<UserActivityTab userId={userId} user={user} />`. The tab order becomes: Overview, Orders, Addresses, Devices, Notes, Activity.

    **RetailerDetailPage**: Add "Activity" as a new tab after "Notes" tab. Import and render `<RetailerActivityTab retailerId={retailerId} retailer={retailer} />`. The tab order becomes: Overview, Orders, Notes, Activity.
  </action>
  <verify>npm run build succeeds; user detail shows Activity tab with timeline; retailer detail shows Activity tab with timeline</verify>
  <done>Activity tabs added to both user and retailer detail pages; timeline shows notes + created/updated events sorted by date; loading and empty states work</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] User detail page has Activity tab as last tab
- [ ] Retailer detail page has Activity tab as last tab
- [ ] Activity tab shows timeline with notes (if any) and created/updated events
- [ ] Timeline events sorted newest-first
- [ ] Relative timestamps display correctly
- [ ] Loading state shows skeleton timeline
- [ ] Empty state shows when no events exist (edge case: user with no notes)
- [ ] Note events show priority badge and author
- [ ] No TypeScript errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- ActivityTimeline is reusable across any entity type
- DETL-10 satisfied with available data (notes + timestamps; full audit log deferred to backend work)
</success_criteria>

<output>
After completion, create `.planning/phases/05-power-features/05-03-SUMMARY.md`
</output>

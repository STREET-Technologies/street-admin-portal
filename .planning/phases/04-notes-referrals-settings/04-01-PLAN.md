---
phase: 04-notes-referrals-settings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/features/notes/types.ts
  - src/features/notes/api/notes-api.ts
  - src/features/notes/api/notes-queries.ts
  - src/features/notes/components/NotesPanel.tsx
  - src/features/users/components/UserNotesTab.tsx
  - src/features/retailers/components/RetailerNotesTab.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view existing notes on a user, sorted newest-first"
    - "Admin can view existing notes on a retailer, sorted newest-first"
    - "Admin can create a new note with priority level on a user"
    - "Admin can create a new note with priority level on a retailer"
    - "New note appears in the list immediately after creation (no refresh)"
    - "Each note shows author name, priority badge, date, and content"
  artifacts:
    - path: "src/features/notes/types.ts"
      provides: "BackendNote type and NoteViewModel"
    - path: "src/features/notes/api/notes-api.ts"
      provides: "getNotes and createNote API functions"
    - path: "src/features/notes/api/notes-queries.ts"
      provides: "useNotesQuery and useCreateNoteMutation hooks"
    - path: "src/features/notes/components/NotesPanel.tsx"
      provides: "Shared notes list + create form component"
    - path: "src/features/users/components/UserNotesTab.tsx"
      provides: "User notes tab wired to NotesPanel"
      min_lines: 10
    - path: "src/features/retailers/components/RetailerNotesTab.tsx"
      provides: "Retailer notes tab wired to NotesPanel"
      min_lines: 10
  key_links:
    - from: "NotesPanel.tsx"
      to: "/admin/notes/:entityType/:entityId"
      via: "useNotesQuery hook"
      pattern: "useNotesQuery"
    - from: "NotesPanel.tsx create form"
      to: "POST /admin/notes"
      via: "useCreateNoteMutation"
      pattern: "useCreateNoteMutation"
    - from: "UserNotesTab.tsx"
      to: "NotesPanel.tsx"
      via: "renders NotesPanel with entityType='user'"
      pattern: "NotesPanel.*entityType.*user"
---

<objective>
Implement the admin notes feature — create and view notes on user and retailer entities.

Purpose: Notes are the primary cross-cutting support feature. Admin team needs to attach context to user/retailer records for handoff between team members. Backend API already exists (`GET/POST /admin/notes/:entityType/:entityId`).

Output: Shared NotesPanel component, notes API layer, working notes tabs on both user and retailer detail pages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context (established patterns):
@.planning/phases/02-users-and-retailers/02-02-SUMMARY.md
@.planning/phases/02-users-and-retailers/02-03-SUMMARY.md

# Existing source files to understand patterns:
@src/lib/api-client.ts
@src/types/index.ts
@src/features/users/types.ts
@src/features/users/api/user-api.ts
@src/features/users/api/user-queries.ts
@src/features/users/components/UserNotesTab.tsx
@src/features/users/components/UserDevicesTab.tsx
@src/features/retailers/components/RetailerNotesTab.tsx
@src/features/users/components/UserDetailPage.tsx
@src/features/retailers/components/RetailerDetailPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notes types, API functions, and TanStack Query hooks</name>
  <files>src/features/notes/types.ts, src/features/notes/api/notes-api.ts, src/features/notes/api/notes-queries.ts</files>
  <action>
    **Types (`src/features/notes/types.ts`):**
    - `BackendNote` interface matching backend AdminNote entity:
      ```
      id: string, entityType: 'user' | 'vendor' | 'courier', entityId: string,
      content: string, priority: 'low' | 'medium' | 'high',
      authorId: string, author: { id: string; firstName: string | null; lastName: string | null; email: string | null },
      createdAt: string, updatedAt: string
      ```
    - `NoteViewModel` with: id, content, priority, authorName (built from author firstName/lastName), authorEmail, createdAt
    - `toNoteViewModel` transform function
    - `CreateNotePayload` type: `{ entityType: 'user' | 'vendor' | 'courier'; entityId: string; content: string; priority: 'low' | 'medium' | 'high' }`
    - Note: Backend uses 'vendor' not 'retailer' for entityType. Map appropriately.
    - `NoteEntityType` type: `'user' | 'vendor' | 'courier'`

    **API (`src/features/notes/api/notes-api.ts`):**
    - `getNotes(entityType: NoteEntityType, entityId: string): Promise<BackendNote[]>` — calls `GET admin/notes/${entityType}/${entityId}`, uses `api.get` (envelope unwrap)
    - `createNote(payload: CreateNotePayload): Promise<BackendNote>` — calls `POST admin/notes` with JSON body, uses `api.post`

    **Query hooks (`src/features/notes/api/notes-queries.ts`):**
    - `noteKeys` factory: `{ all: ['notes'], list: (entityType, entityId) => ['notes', entityType, entityId] }`
    - `useNotesQuery(entityType, entityId)` — TanStack Query hook, `select` maps through `toNoteViewModel`, sorts by `createdAt` descending (newest first)
    - `useCreateNoteMutation(entityType, entityId)` — TanStack Query mutation, on success invalidates `noteKeys.list(entityType, entityId)` to refetch. Uses `useMutation` from `@tanstack/react-query` and `useQueryClient` for invalidation.

    Follow established patterns from `user-api.ts` and `user-queries.ts`. Import `api` from `@/lib/api-client`. Import query client from `@tanstack/react-query`.
  </action>
  <verify>Run `npx tsc --noEmit` — no TypeScript errors in notes files</verify>
  <done>Notes types, API functions, and query hooks exist and type-check cleanly</done>
</task>

<task type="auto">
  <name>Task 2: Create shared NotesPanel component and wire into user and retailer tabs</name>
  <files>src/features/notes/components/NotesPanel.tsx, src/features/users/components/UserNotesTab.tsx, src/features/retailers/components/RetailerNotesTab.tsx</files>
  <action>
    **NotesPanel (`src/features/notes/components/NotesPanel.tsx`):**

    Shared component that both UserNotesTab and RetailerNotesTab render. Props: `{ entityType: NoteEntityType; entityId: string }`.

    **Layout (top to bottom):**
    1. **Create note form** at top — a Card containing:
       - Textarea for note content (placeholder: "Add a note...")
       - Row with: priority select (low/medium/high, default 'medium') + Submit button ("Add Note")
       - Use shadcn Select for priority, shadcn Button for submit
       - On submit: call `useCreateNoteMutation`, clear form on success, show toast on success ("Note added") and error ("Failed to add note")
       - Disable button while mutation is pending, show loading state
       - Use controlled form state (useState for content and priority), NOT react-hook-form (overkill for 2 fields)
    2. **Notes list** below — renders each NoteViewModel as a Card:
       - Card header: author name (bold) + priority badge (use StatusBadge or a simple colored badge — low=gray, medium=blue, high=orange) + relative time or formatted date
       - Card content: note content text (whitespace-pre-wrap for multi-line)
       - Sort: newest first (already sorted in query hook)
    3. **States:** LoadingState (variant="card", rows=3), ErrorState with retry, EmptyState ("No notes yet" with StickyNote icon)

    **Priority badge colors:** Use a simple inline badge (not StatusBadge which is for entity statuses):
    - low: `bg-muted text-muted-foreground`
    - medium: `bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300`
    - high: `bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300`

    **Date formatting:** Use `toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })` + `toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })` — matching existing date patterns.

    **Wire UserNotesTab:**
    Replace the current EmptyState placeholder. Accept `{ userId: string }` props. Render `<NotesPanel entityType="user" entityId={userId} />`.

    **Wire RetailerNotesTab:**
    Replace the current EmptyState placeholder. Accept `{ retailerId: string }` props. Render `<NotesPanel entityType="vendor" entityId={retailerId} />`. Note: backend uses 'vendor' not 'retailer'.

    **Ensure tab props are passed correctly:**
    Check UserDetailPage.tsx and RetailerDetailPage.tsx — the tabs must pass the entity ID to the notes tab component. If they don't currently, add the prop. UserDetailPage likely has `user.id` available; RetailerDetailPage likely has `retailer.id` available.
  </action>
  <verify>
    Run `npx tsc --noEmit` — no TypeScript errors.
    Run `npm run build` — build succeeds.
  </verify>
  <done>
    - NotesPanel renders create form + notes list with loading/error/empty states
    - UserNotesTab renders NotesPanel with entityType="user"
    - RetailerNotesTab renders NotesPanel with entityType="vendor"
    - Creating a note calls POST /admin/notes and the list refreshes via query invalidation
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds
- [ ] Notes feature files exist in src/features/notes/
- [ ] UserNotesTab is no longer a placeholder
- [ ] RetailerNotesTab is no longer a placeholder
- [ ] NotesPanel has both create form and list display
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Notes types/API/queries follow established patterns from users/retailers features
- NotesPanel handles loading, error, empty, and populated states
- Create note form validates non-empty content before submit
- Priority defaults to "medium"
- Notes display newest-first with author, priority, date, and content
</success_criteria>

<output>
After completion, create `.planning/phases/04-notes-referrals-settings/04-01-SUMMARY.md`
</output>

---
phase: 04-notes-referrals-settings
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/features/users/types.ts
  - src/features/users/components/UserDevicesTab.tsx
  - src/app/routes/_authenticated/referrals/index.tsx
  - src/app/routes/_authenticated/settings/index.tsx
autonomous: true

must_haves:
  truths:
    - "Device info tab shows real backend fields (token, deviceName, platform, isActive)"
    - "Referrals page explains that admin referral management requires backend endpoints"
    - "Settings page shows as Phase 5 placeholder"
  artifacts:
    - path: "src/features/users/types.ts"
      provides: "BackendUserDevice matching FcmToken entity shape"
    - path: "src/features/users/components/UserDevicesTab.tsx"
      provides: "Device cards showing real FcmToken fields"
    - path: "src/app/routes/_authenticated/referrals/index.tsx"
      provides: "Referrals page with backend-needed explanation"
    - path: "src/app/routes/_authenticated/settings/index.tsx"
      provides: "Settings page placeholder"
  key_links: []
---

<objective>
Fix device info type mismatch and update referrals/settings placeholder pages.

Purpose: INFR-07 (device info) needs real backend data display — the current BackendUserDevice type doesn't match the actual FcmToken entity returned by the backend. Referrals page needs an informative placeholder explaining backend dependency (no admin referral endpoints exist). Settings stays as Phase 5 placeholder.

Output: Accurate device info display, informative referrals page, updated settings page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Source files to modify:
@src/features/users/types.ts
@src/features/users/components/UserDevicesTab.tsx
@src/features/users/api/user-api.ts
@src/app/routes/_authenticated/referrals/index.tsx
@src/app/routes/_authenticated/settings/index.tsx

# Backend FcmToken entity shape (from research):
# id: string (UUID)
# token: string (FCM push token)
# vendorId: string | null
# userId: string | null
# recipientType: 'vendor' | 'user' (default: 'vendor')
# platform: 'web' | 'ios' | 'android' (default: 'web')
# deviceName: string | null
# deviceId: string | null
# metadata: Record<string, any> | null (JSONB)
# isActive: boolean (default: true)
# lastUsedAt: string | null
# createdAt: string
# updatedAt: string
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix BackendUserDevice type and update UserDevicesTab</name>
  <files>src/features/users/types.ts, src/features/users/components/UserDevicesTab.tsx</files>
  <action>
    **Update BackendUserDevice type in `src/features/users/types.ts`:**
    Replace the current BackendUserDevice interface to match the actual backend FcmToken entity:
    ```
    interface BackendUserDevice {
      id: string;
      token: string;
      platform: 'web' | 'ios' | 'android';
      deviceName: string | null;
      deviceId: string | null;
      recipientType: 'vendor' | 'user';
      isActive: boolean;
      lastUsedAt: string | null;
      metadata: Record<string, unknown> | null;
      createdAt: string;
      updatedAt: string;
    }
    ```
    Remove the old fields: model, osVersion, appVersion, pushToken — these don't exist in the backend response.

    **Update UserDevicesTab component:**
    Update the device card to show real FcmToken fields:
    - Title: `device.deviceName ?? device.platform ?? "Unknown Device"` (was: device.model)
    - Platform: show `device.platform` capitalized (keep existing)
    - Device ID: show `device.deviceId` if present (new field)
    - Status: show active/inactive badge using `device.isActive` (new field)
    - Last Used: show `device.lastUsedAt` formatted date if present (new field)
    - Registered: keep existing `device.createdAt` display
    - Remove: osVersion and appVersion display sections (these fields don't exist)
    - Token: show truncated FCM token (first 20 chars + "...") in a muted, monospace style — useful for debugging push notification issues

    Keep the same card grid layout (md:grid-cols-2 lg:grid-cols-3). Keep loading/error/empty states unchanged.
  </action>
  <verify>Run `npx tsc --noEmit` — no TypeScript errors</verify>
  <done>BackendUserDevice matches FcmToken entity. Device cards show real fields.</done>
</task>

<task type="auto">
  <name>Task 2: Update referrals and settings placeholder pages</name>
  <files>src/app/routes/_authenticated/referrals/index.tsx, src/app/routes/_authenticated/settings/index.tsx</files>
  <action>
    **Referrals page (`src/app/routes/_authenticated/referrals/index.tsx`):**
    Replace the current placeholder with a more informative page explaining the backend gap:
    - PageHeader title: "Referral Codes", description: "Manage referral codes and promotions"
    - Content: A Card with:
      - CardHeader: title "Backend Endpoints Needed"
      - CardContent: Brief explanation that the referral system exists in the backend (users can share/claim codes, earn credit) but no admin-facing API endpoints exist yet for listing, searching, or managing referral codes. List what endpoints would be needed:
        - `GET /admin/referral-codes` — list all codes with pagination
        - `GET /admin/users/:userId/referral` — get user's referral code
        - `PATCH /admin/referral-codes/:id` — toggle code active status
      - Use a muted text style, keep it concise
      - Note at bottom: "This is tracked in the project backlog for a backend sprint."
    - Do NOT use EmptyState — use a real Card with structured info instead

    **Settings page (`src/app/routes/_authenticated/settings/index.tsx`):**
    Update to say "Phase 5" instead of the current placeholder. Keep it simple:
    - PageHeader title: "Settings", description: "Application configuration"
    - EmptyState: icon=Settings, title="Coming in Phase 5", description="Settings including referral configuration will be built in Phase 5."
  </action>
  <verify>Run `npm run build` — build succeeds</verify>
  <done>Referrals page shows informative backend-needed explanation. Settings page references Phase 5.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds
- [ ] BackendUserDevice type matches FcmToken entity fields
- [ ] UserDevicesTab shows real backend fields (no model/osVersion/appVersion)
- [ ] Referrals page has structured explanation, not generic placeholder
- [ ] Settings page references Phase 5
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Device info types accurately reflect backend reality
- Referrals page communicates backend dependency clearly
- No TypeScript errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/04-notes-referrals-settings/04-02-SUMMARY.md`
</output>
